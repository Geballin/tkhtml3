
# Test script for Tkhtml
proc sourcefile {file} {
  set fname [file join [file dirname [info script]] $file] 
  uplevel #0 [list source $fname]
}
sourcefile common.tcl

html .h
.h handler script style styleHandler 
proc styleHandler {data} {
  .h style $data
}

proc property {node prop} {
  array set properties [$node prop]
  return $properties($prop)
}

#--------------------------------------------------------------------------
# Test cases style-1.* test the parsing of the 'background-position' property.
#
tcltest::test style-1.0 {} -body {
  .h parse -final {
    <html>
    <style>
      .one {background-position: 50% 50%}
      .two {background-position: center center}
      .three {background-position: 111 222}
    </style>
    <body>
    <div class="one"/>
    <div class="two"/>
    <div class="three"/>
    <div class="four"/>
    </body>
    </html>
  }

  set node [lindex [.h search .one] 0]
  property $node background-position
} -result {50.00% 50.00%}

tcltest::test style-1.1 {} -body {
  set node [lindex [.h search .two] 0]
  property $node background-position
} -result {50.00% 50.00%}

tcltest::test style-1.2 {} -body {
  set node [lindex [.h search .three] 0]
  property $node background-position
} -result {111px 222px}


#--------------------------------------------------------------------------
# Test cases style-2.* test the parsing of the 'background' property.
#
tcltest::test style-2.0 {} -body {
  .h reset
  .h parse -final {
    <html>
    <style>
      .one {background: black url(shell-bg.jpg) 0 0 no-repeat fixed;}
      .two {background: black url(shell-bg.jpg) 50 no-repeat 100 fixed;}
    </style>
    <body>
    <div class="one"/>
    <div class="two"/>
    </body>
    </html>
  }

  set node [lindex [.h search .one] 0]
  property $node background-position
} -result {0px 0px}

tcltest::test style-2.1 {} -body {
  property $node background-color
} -result {black}

tcltest::test style-2.2 {} -body {
  set node2 [lindex [.h search .two] 0]
  property $node2 background-position
} -result {50px 100px}

tcltest::test style-2.3 {} -body {
  property $node2 background-repeat
} -result {no-repeat}

#--------------------------------------------------------------------------
# Test cases style-3.* test some selectors
#
tcltest::test style-3.0 {} -body {
  .h reset
  .h parse -final {
    <html>
    <style>
      i {color:red}
      body>b {color:red}
    </style>
    <body>
    <i>Hello</i>
    <b>Hello</i>
    </body>
    </html>
  }

  set node [lindex [.h search i] 0]
  property $node color
} -result {red}
tcltest::test style-3.1 {} -body {
  set node [lindex [.h search b] 0]
  property $node color
} -result {red}

#--------------------------------------------------------------------------
# The following tests (style-4.*) test the parsing of stylesheets.
#
proc parse_stylesheet {stylesheet_text} {
  html .newwidget -defaultstyle ""
  .newwidget style $stylesheet_text
  set ret [list]
  foreach r [.newwidget styleconfig] {
    lappend ret [lrange $r 0 1]
  }
  destroy .newwidget
  return $ret
}

#
# Test 4.1 tests the bug reported by ticket #43. The embedded stylesheet
# contains an error - a ":" character is missing from a declaration. The
# correct behaviour is to ignore the broken declaration and resume
# parsing after the following semi-colon. In other words, the style-sheet
# specified in the <STYLE> element should parse identically to:
#
#     div {
#         color: red;
#         background-color: green;
#     }
#
tcltest::test style-4.1.1 {} -body {
  parse_stylesheet {
      div {
        color: red;
        garbage moregarbage;
        background-color: green;
      }
  }
} -result {{div {color:red; background-color:green}}}

# Test 4.2 tests that semi-colons are treated correctly. 
tcltest::test style-4.2.1 {} -body {
  parse_stylesheet {
      div {
        color: red;; ; background-color: green
      }
  }
} -result {{div {color:red; background-color:green}}}
tcltest::test style-4.2.2 {} -body {
  parse_stylesheet {
      div {
        ;color: red;; ; background-color: green; ; ;
      ;}
  }
} -result {{div {color:red; background-color:green}}}

# Test 4.3 tests for parsing errors using the examples given in the CSS 2.1
# specification, section 4.2. All of the following declarations should
# be equivalent to "p {color:green}".
set tn 1
foreach ss [list \
  {p { color:green }}                                    \
  {p { color:green; color }}                             \
  {p { color:red;   color; color:green }}                \
  {p { color:green; color: }}                            \
  {p { color:red;   color:; color:green }}               \
  {p { color:green; {some more garbage}}}                \
  {p { some more garbage; color: green}}                 \
  {p { {some more garbage}; color: green}}               \
  {p { color:green; color{;color:maroon} }}              \
  {p { color:red;   color{;color:maroon}; color:green }}  
] {
  tcltest::test style-4.3.$tn {} -body {
    parse_stylesheet $ss
  } -result {{p color:green}}
  incr tn
}

#--------------------------------------------------------------------------
# Test cases numbered 5.* test that the parser correctly negotiates 
# @media blocks.

# Given the stylesheet document $style, return the number of @import 
# directives contained in the document that should be used by Tkhtml.
proc count_import_directives {style} {
}
proc incrvar {varname args} {
  uplevel #0 [list incr $varname]
}

# The following block comes from the page at www.theaustralian.com.au.
# I have no idea what they are trying to achieve, but I do know the 
# page renders incorrectly if the @import directives are recognised.
# So the following test cases test that they are ignored.
set ::style_block "
/* IE legacy version fixes - leave at end */
@media tty {
   i{content:\"\";/*\" \"*/}}@m; @import '/css/ie55/0,20954,,00.css'; /*\";}
   }/* */

@media tty {
   i{content:\"\";/*\" \"*/}}; @import '/css/ie50/0,20955,,00.css'; {;}/*\";}
   }/* */
"
tcltest::test style-5.1 {} -body {
  html .newwidget 
  set ::import_cnt 0
  .newwidget style -importcmd [list incrvar ::import_cnt] $::style_block
  destroy .newwidget
  set ::import_cnt
} -result {0}


tcltest::test style-6.1 {} -body {
  parse_stylesheet {
    #nav-main {background: #fc3 url(/files/theme/nav-main.png) repeat-x 0 100%;}
  }
} -result [list [list \
  {[id="nav-main"]}  \
  {background-image:url(/files/theme/nav-main.png); background-attachment:scrol; background-color:#fc3; background-repeat:repeat-x; background-position-x:0.00; background-position-y:100.00%}
]]

finish_test

